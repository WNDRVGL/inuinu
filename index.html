<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã„ã¬ã£ãƒ”ãƒ¼</title>
<style>
:root{
  --bg:#fff4db;      /* è–„ã„ã‚¯ãƒªãƒ¼ãƒ ï¼ˆå·¦å³ä½™ç™½ï¼‰ */
  --panel:#ffffff;
  --panel2:#fff8e9;
  --historyBg:#eaf6ff; /* éå»10å›ã®èƒŒæ™¯è‰² */
  --ink:#2b2b2b;
  --muted:#6b6b6b;
  --good:#1f9d63;
  --bad:#d65a5a;
  --line:rgba(0,0,0,.10);
  --shadow:rgba(0,0,0,.15);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo", sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  overflow:hidden;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  padding:16px; /* PCã§ã‚‚å‘¨ã‚Šã¯èƒŒæ™¯è‰² */
}

/* âœ… å…¨ä½“ã®é«˜ã•ã‚’700pxä»¥å†…ã«å›ºå®šï¼ˆã‚µã‚¤ã‚ºä»¥å¤–å¤‰æ›´ãªã—ï¼‰ */
.phone{
  width:100%;
  max-width:390px;
  height:700px;              /* â† æŒ‡å®š */
  max-height:700px;          /* â† å¿µã®ãŸã‚ */
  background:var(--panel);
  border-radius:22px;
  box-shadow:0 20px 60px var(--shadow);
  border:1px solid var(--line);
  position:relative;
  overflow:hidden;
}

/* ä¸Šéƒ¨ */
.titlebar{
  position:absolute;
  top:0; left:0; right:0;
  padding:14px 14px 10px;
  background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,0));
  z-index:3;
}
.title{
  font-weight:950;
  font-size:16px;
  letter-spacing:.2px;
}
.toprow{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
  font-weight:950;
  font-size:14px;
}
.toprow small{
  color:rgba(0,0,0,.55);
  font-weight:900;
}

/* âœ… ã‚²ãƒ¼ãƒ éƒ¨åˆ†ã®é«˜ã•ã‚’600pxï¼ˆãŸã ã—å…¨ä½“700å†…ã«åã‚ã‚‹ãŸã‚ stage-bottom ã‚’èª¿æ•´ï¼‰ */
.stage{
  position:absolute;
  top:80px;
  left:0; right:0;
  height:480px;            /* â† å…¨ä½“700pxã«åã‚ã‚‹ãŸã‚ç¸®å°ï¼ˆâ€»è¦ä»¶ã®æ•´åˆä¸Šã“ã“ã¯å¿…é ˆï¼‰ */
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:12px;
  padding:0 14px;
}

.dog-area{
  position:relative;
  width:100%;
  height:240px;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* ã‚­ãƒ£ãƒ© */
canvas{
  width:300px;
  height:230px;
  image-rendering:pixelated;
  filter: drop-shadow(0 14px 0 rgba(0,0,0,.10));
}

/* å¹ãå‡ºã— */
.bubble{
  position:absolute;
  top:-12px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(255,255,255,.92);
  padding:16px 22px;
  border-radius:20px;
  font-weight:950;
  border:1px solid var(--line);
  box-shadow:0 12px 34px rgba(0,0,0,.10);
  min-width:210px;
  text-align:center;
  white-space:nowrap;
  transition: opacity .14s ease, transform .14s ease;
  z-index:2;
}
.bubble:after{
  content:"";
  position:absolute;
  left:50%;
  bottom:-14px;
  transform: translateX(-50%);
  border-width:14px 14px 0 14px;
  border-style:solid;
  border-color: rgba(255,255,255,.92) transparent transparent transparent;
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.06));
}
.bubble.hidden{
  opacity:0;
  transform:translateX(-50%) translateY(-10px);
  pointer-events:none;
}
.bubble.muted{ opacity:.75; }

/* ã‚¿ãƒƒãƒ—éƒ¨ */
.tapArea{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.gain{
  height:24px;
  font-weight:950;
  opacity:0;
  transition:.2s;
  letter-spacing:.2px;
}
.gain.show{opacity:1; transform:translateY(-2px)}
.gain.good{color:var(--good)}
.gain.bad{color:var(--bad)}
.tapEcho{
  min-height:26px;
  font-weight:950;
  letter-spacing:.3px;
  color: rgba(0,0,0,.68);
  display:flex;
  align-items:center;
  justify-content:center;
  width: min(340px, 100%);
}
.tapEcho .wan{
  display:inline-block;
  padding:6px 10px;
  border-radius:14px;
  background: rgba(255,255,255,.82);
  border:1px solid var(--line);
  box-shadow: 0 8px 20px rgba(0,0,0,.06);
  max-width:100%;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space:nowrap;
}
.panel{
  width:340px;
  background:var(--panel2);
  border-radius:16px;
  padding:8px 10px;
  border:1px solid var(--line);
  text-align:center;
  font-size:12px;
  font-weight:850;
  color: rgba(0,0,0,.66);
  box-shadow: 0 12px 30px rgba(0,0,0,.07);
}
.panel strong{ color:#7a5a00; }
.big{
  width:340px;
  padding:12px;
  border-radius:16px;
  background: linear-gradient(180deg, rgba(255,204,51,.28), rgba(255,204,51,.12));
  border:1px solid rgba(255,204,51,.45);
  font-weight:950;
  text-align:center;
  display:flex;
  justify-content:center;
  align-items:center;
  letter-spacing:.2px;
  box-shadow: 0 10px 26px rgba(0,0,0,.08);
}

/* âœ… éå»10å›ï¼šé«˜ã•200pxå›ºå®š */
.bottomHistory{
  position:absolute;
  left:0; right:0;
  bottom:0;
  height:200px;            /* â† æŒ‡å®š */
  background: var(--historyBg);
  border-top:1px solid var(--line);
  padding:10px 12px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  z-index:2;
}
.bottomHistory h3{
  font-size:12px;
  margin:0;
  font-weight:950;
  letter-spacing:.2px;
  color: rgba(0,0,0,.55);
}

/* 3ä»¶åˆ†ã¾ã§è¦‹ã›ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
.histRows{
  overflow-y:auto;
  flex:0 0 auto;
  max-height:132px;
  padding-right:6px;
}
.histRow{
  background:rgba(255,255,255,.86);
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  margin-bottom:8px;
  font-weight:950;
  display:flex;
  justify-content:space-between;
  font-size:13px;
  box-shadow: 0 6px 14px rgba(0,0,0,.05);
}
.histRow small{
  color: rgba(0,0,0,.50);
  font-weight:900;
}

/* çµ‚äº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.endOverlay{
  position:absolute;
  inset:0;
  background: rgba(255,244,219,.78);
  backdrop-filter: blur(3px);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition: opacity .18s ease;
  z-index:4;
}
.endOverlay.show{
  opacity:1;
  pointer-events:auto;
}
.endCard{
  width: min(340px, 92%);
  border-radius:18px;
  background: rgba(255,255,255,.92);
  border:1px solid var(--line);
  box-shadow: 0 20px 60px rgba(0,0,0,.18);
  padding:16px 16px 14px;
  text-align:center;
}
.endCard h2{
  margin:0 0 8px;
  font-size:18px;
  letter-spacing:.2px;
  font-weight:950;
}
.endScore{
  font-size:32px;
  font-weight:980;
  letter-spacing:.4px;
  margin:6px 0 10px;
}
.endHint{
  margin:0;
  color: rgba(0,0,0,.55);
  font-weight:900;
  font-size:13px;
  line-height:1.35;
}

/* ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—å—ã‘ */
.taplayer{
  position:absolute;
  inset:0;
  z-index:1;
  cursor:pointer;
}
</style>
</head>
<body>
<div class="phone" id="phone">
  <div class="titlebar">
    <div class="title">åƒ•ã¯ã„ã¬ã£ãƒ”ãƒ¼ã€ä¸€ç·’ã«ãŠè©±ã—ã—ã‚ˆã†</div>
    <div class="toprow">
      <div><small>ã®ã“ã‚Š</small> <span id="time">2:30</span></div>
      <div><small>ã‚¹ã‚³ã‚¢</small> <span id="score">0</span></div>
    </div>
  </div>

  <div class="stage">
    <div class="dog-area">
      <div class="bubble muted" id="bubble">ãƒ¯ãƒ³</div>
      <canvas id="dog" width="400" height="320" aria-label="ã„ã¬ã£ãƒ”ãƒ¼"></canvas>
    </div>

    <div class="tapArea">
      <div class="gain" id="gain"></div>
      <div class="tapEcho" id="tapEcho" aria-live="polite"></div>

      <div class="panel">
        å¹ãå‡ºã—ã® <strong>ãƒ¯ãƒ³</strong> ã®æ•°ã ã‘ã‚¿ãƒƒãƒ—ã€‚<br>
        ã´ã£ãŸã‚Šã§ã‚‚ã€ã¡ã‚‡ã„å¾…ã£ã¦ç¢ºå®šã€‚æŠ¼ã—ã™ãæ³¨æ„ã€‚
      </div>

      <div class="big" id="big">ã‚¿ãƒƒãƒ—ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
    </div>
  </div>

  <div class="bottomHistory" aria-label="éå»10å›ã®ã‚¹ã‚³ã‚¢">
    <h3>éå»10å›ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¾ã§ï¼‰</h3>
    <div class="histRows" id="historyRows"></div>
  </div>

  <div class="endOverlay" id="endOverlay" aria-hidden="true">
    <div class="endCard">
      <h2>ãŠã‚ã‚Šï¼</h2>
      <div class="endScore" id="endScore">0</div>
      <p class="endHint">ã‚¿ãƒƒãƒ— / Space ã§ã‚‚ã†ä¸€å›<br>ï¼ˆå±¥æ­´ã¯ä¸‹ã«æ®‹ã‚Šã¾ã™ï¼‰</p>
    </div>
  </div>

  <div class="taplayer" id="taplayer" aria-hidden="true"></div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const c = $('dog');
  const ctx = c.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  const bubble = $('bubble');
  const scoreEl = $('score');
  const timeEl = $('time');
  const gainEl = $('gain');
  const tapEcho = $('tapEcho');
  const historyRows = $('historyRows');
  const taplayer = $('taplayer');

  const endOverlay = $('endOverlay');
  const endScore = $('endScore');

  const history = [];
  function renderHistory(){
    historyRows.innerHTML = '';
    if(history.length === 0){
      const row = document.createElement('div');
      row.className = 'histRow';
      row.innerHTML = `<small>â€”</small><span>â€”</span>`;
      historyRows.appendChild(row);
      return;
    }
    const max = Math.max(...history);
    history.slice().reverse().forEach((s, i) => {
      const row = document.createElement('div');
      row.className = 'histRow';
      const isMax = (s === max);
      row.innerHTML = `<small>#${history.length - i}</small><span>${isMax ? 'ğŸ‘‘ ' : ''}${s}</span>`;
      historyRows.appendChild(row);
    });
  }
  renderHistory();

  const GAME_SECONDS = 150;
  const S = {
    phase: 'title',
    score: 0,
    time: GAME_SECONDS,
    timer: null,
    target: 0,
    inputs: 0,
    allowInput: false,
    lockedUntil: 0,
    confirmTimer: null,
    dogState: 'idle',
    roundPending: false,
  };

  function fmtTime(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m}:${String(s).padStart(2,'0')}`;
  }

  function showGain(text, kind){
    gainEl.textContent = text;
    gainEl.className = `gain ${kind} show`;
    setTimeout(() => gainEl.classList.remove('show'), 650);
  }

  function setBubbleWan(n, muted=false){
    bubble.textContent = 'ãƒ¯ãƒ³'.repeat(n);
    bubble.classList.toggle('muted', muted);
    bubble.classList.remove('hidden');
  }
  function hideBubble(){ bubble.classList.add('hidden'); }
  function setDogState(s){ S.dogState = s; }

  function drawDog(state){
    const w = c.width, h = c.height;
    ctx.clearRect(0,0,w,h);

    const t = performance.now();
    const floatY = Math.round(Math.sin(t/260) * 2);
    const popY   = (state === 'good') ? Math.round(Math.sin(t/90)*3) : 0;
    const oy = floatY - popY;

    for(let i=0;i<220;i++){
      const x = (i*37)%w;
      const y = (i*61)%h;
      ctx.fillStyle = 'rgba(0,0,0,0.03)';
      ctx.fillRect(x, y, 1, 1);
    }

    const px = 5;
    function rect(x,y,ww,hh,color){
      ctx.fillStyle = color;
      ctx.fillRect(x*px, (y+oy)*px, ww*px, hh*px);
    }

    const fur1 = '#caa36a';
    const fur2 = '#b38d58';
    const dark = '#3a2b1d';
    const ink  = '#111318';
    const white= '#f3f0e9';
    const blush= '#ff7aa2';
    const acc  = '#ffcc33';

    rect(16, 50, 34, 6, 'rgba(0,0,0,0.12)');

    rect(20, 32, 26, 15, fur1);
    rect(20, 32, 26, 2, fur2);
    rect(20, 45, 26, 2, fur2);

    rect(18, 22, 11, 11, fur1);
    rect(29, 18, 15, 15, fur1);
    rect(29, 18, 15, 2, fur2);
    rect(29, 31, 15, 2, fur2);

    rect(27, 18, 4, 7, fur2);
    rect(44, 18, 4, 7, fur2);

    rect(33, 23, 2, 2, ink);
    rect(39, 23, 2, 2, ink);

    if(state === 'good'){
      rect(31, 27, 2, 1, blush);
      rect(41, 27, 2, 1, blush);
    }

    if(state === 'bark'){
      rect(36, 27, 2, 1, dark);
      rect(35, 28, 4, 3, dark);
      rect(36, 29, 2, 1, acc);
    } else if(state === 'bad'){
      rect(35, 28, 6, 1, dark);
      rect(36, 29, 4, 1, dark);
    } else {
      rect(36, 28, 2, 1, dark);
      rect(35, 29, 4, 1, dark);
    }

    rect(37, 26, 2, 1, ink);

    rect(26, 37, 12, 8, white);

    rect(22, 47, 6, 5, fur2);
    rect(36, 47, 6, 5, fur2);

    const wag = Math.round(Math.sin(t/200) * 1);
    rect(46+wag, 36, 6, 2, fur2);
    rect(50+wag, 34, 2, 2, fur2);

    rect(19, 32, 1, 15, 'rgba(0,0,0,0.10)');
    rect(45, 32, 1, 15, 'rgba(0,0,0,0.10)');
  }

  function loop(){
    drawDog(S.dogState);
    requestAnimationFrame(loop);
  }
  loop();

  function targetByTime(){
    const elapsed = GAME_SECONDS - S.time;
    let weights;
    if(elapsed < 50)       weights = [0.45,0.33,0.18,0.04,0.00];
    else if(elapsed < 100) weights = [0.12,0.28,0.30,0.20,0.10];
    else                   weights = [0.08,0.14,0.26,0.28,0.24];
    const r = Math.random();
    let acc = 0;
    for(let i=0;i<weights.length;i++){
      acc += weights[i];
      if(r <= acc) return i+1;
    }
    return 3;
  }

  function barkAnim(n, done){
    let i = 0;
    const interval = 170;
    const step = () => {
      if(S.phase !== 'play') return;
      setDogState('bark');
      setTimeout(() => setDogState('idle'), 90);

      i++;
      if(i >= n){
        setTimeout(() => { setDogState('idle'); done(); }, 140);
        return;
      }
      setTimeout(step, interval);
    };
    step();
  }

  function renderTapEcho(){
    if(S.inputs <= 0){
      tapEcho.innerHTML = '';
      return;
    }
    const txt = 'ãƒ¯ãƒ³'.repeat(S.inputs);
    tapEcho.innerHTML = `<span class="wan">${txt}</span>`;
    const node = tapEcho.firstElementChild;
    if(node && S.inputs >= 6){
      node.style.fontSize = '12px';
      node.style.letterSpacing = '0px';
    }
  }

  function nextRound(delayMs){
    if(S.phase !== 'play') return;
    if(S.roundPending) return;
    S.roundPending = true;

    setTimeout(() => {
      S.roundPending = false;
      if(S.phase !== 'play') return;

      S.target = targetByTime();
      S.inputs = 0;
      S.allowInput = false;
      renderTapEcho();
      gainEl.classList.remove('show');

      setBubbleWan(S.target, false);

      barkAnim(S.target, () => {
        S.lockedUntil = performance.now() + 250;
        S.allowInput = true;
        setTimeout(() => hideBubble(), 1180);
      });
    }, delayMs);
  }

  function startGame(){
    endOverlay.classList.remove('show');
    endOverlay.setAttribute('aria-hidden','true');

    S.phase = 'play';
    S.score = 0;
    scoreEl.textContent = '0';
    S.time = GAME_SECONDS;
    timeEl.textContent = fmtTime(S.time);

    $('big').textContent = 'ãƒ¯ãƒ³ã®æ•°ã ã‘ã‚¿ãƒƒãƒ—';
    tapEcho.innerHTML = '';
    gainEl.textContent = '';
    gainEl.classList.remove('show');

    setDogState('idle');
    setBubbleWan(1, true);

    if(S.timer) clearInterval(S.timer);
    S.timer = setInterval(() => {
      if(S.phase !== 'play') return;
      S.time = Math.max(0, S.time - 1);
      timeEl.textContent = fmtTime(S.time);
      if(S.time <= 0){
        endGame();
      }
    }, 1000);

    nextRound(250);
  }

  function endGame(){
    if(S.phase !== 'play') return;
    S.phase = 'result';

    if(S.timer) { clearInterval(S.timer); S.timer = null; }
    if(S.confirmTimer){ clearTimeout(S.confirmTimer); S.confirmTimer = null; }

    history.push(S.score);
    while(history.length > 10) history.shift();
    renderHistory();

    setDogState('idle');
    setBubbleWan(1, true);
    hideBubble();
    tapEcho.innerHTML = '';
    $('big').textContent = '';

    endScore.textContent = String(S.score);
    endOverlay.classList.add('show');
    endOverlay.setAttribute('aria-hidden','false');
  }

  function succeedRound(){
    if(S.phase !== 'play') return;

    const add = S.target * 100;
    S.score += add;
    scoreEl.textContent = String(S.score);

    setDogState('good');
    showGain(`+${add}`, 'good');

    setTimeout(() => setDogState('idle'), 260);
    nextRound(900);
  }

  function failRound(){
    if(S.phase !== 'play') return;
    if(S.confirmTimer){ clearTimeout(S.confirmTimer); S.confirmTimer = null; }

    setDogState('bad');
    showGain('0', 'bad');

    setTimeout(() => setDogState('idle'), 280);
    nextRound(950);
  }

  function onInput(){
    if(S.phase === 'title' || S.phase === 'result'){
      startGame();
      return;
    }
    if(S.phase !== 'play') return;
    if(!S.allowInput) return;

    const now = performance.now();
    if(now < S.lockedUntil) return;

    S.inputs += 1;
    renderTapEcho();

    if(S.inputs > S.target){
      failRound();
      return;
    }

    if(S.inputs === S.target){
      if(S.confirmTimer) clearTimeout(S.confirmTimer);
      $('big').textContent = 'â€¦';
      S.confirmTimer = setTimeout(() => {
        S.confirmTimer = null;
        $('big').textContent = 'ãƒ¯ãƒ³ã®æ•°ã ã‘ã‚¿ãƒƒãƒ—';
        succeedRound();
      }, 350);
    }
  }

  setBubbleWan(1, true);
  $('big').textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ';

  taplayer.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    onInput();
  }, {passive:false});

  window.addEventListener('keydown', (e) => {
    if(e.code === 'Space'){
      e.preventDefault();
      onInput();
    }
  }, {passive:false});

  endOverlay.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    startGame();
  }, {passive:false});

  window.addEventListener('touchmove', (e) => e.preventDefault(), {passive:false});
})();
</script>
</body>
</html>
